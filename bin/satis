#!/usr/bin/env php
<?php

/*
 * This file is part of composer/satis.
 *
 * (c) Composer <https://github.com/composer>
 *
 * For the full copyright and license information, please view
 * the LICENSE file that was distributed with this source code.
 */

namespace Composer\Satis\Builder {
    function realpath($dir)
    {
        return $dir;
    }
}

namespace Composer\Package\Archiver {
    function realpath($dir)
    {
        return $dir;
    }
}

namespace {

    use Symfony\Component\Dotenv\Dotenv;

    function includeIfExists($file)
    {
        if (file_exists($file)) {
            return include $file;
        }
    }

    if ((!$loader = includeIfExists(__DIR__ . '/../vendor/autoload.php')) && (!$loader = includeIfExists(__DIR__ . '/../../../autoload.php'))) {
        print('You must set up the project dependencies using Composer before you can use Satis.');
        exit(1);
    }

    if (!array_key_exists('APP_ENV', $_SERVER)) {
        $_SERVER['APP_ENV'] = $_ENV['APP_ENV'] ?? null;
    }

    if ('prod' !== $_SERVER['APP_ENV']) {
        if (!class_exists(Dotenv::class)) {
            throw new RuntimeException('The "APP_ENV" environment variable is not set to "prod". Please run "composer require symfony/dotenv" to load the ".env" files configuring the application.');
        }

        (new Dotenv())->loadEnv(dirname(__DIR__).'/.env');
    }

    $_SERVER['APP_ENV'] = $_ENV['APP_ENV'] = $_SERVER['APP_ENV'] ?: $_ENV['APP_ENV'] ?: 'dev';
    $_SERVER['APP_DEBUG'] = $_SERVER['APP_DEBUG'] ?? $_ENV['APP_DEBUG'] ?? 'prod' !== $_SERVER['APP_ENV'];
    $_SERVER['APP_DEBUG'] = $_ENV['APP_DEBUG'] = (int) $_SERVER['APP_DEBUG'] || filter_var($_SERVER['APP_DEBUG'], FILTER_VALIDATE_BOOLEAN) ? '1' : '0';


    $application = new Composer\Satis\Console\Application();
    $application->run();

}

